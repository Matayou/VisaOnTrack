// SawadeePass v2 - Prisma Schema
// Schema-first design per Section 3 data model
// Generated: Pivot (Remove Escrow, Add Credits)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SEEKER
  PROVIDER
  ADMIN
}

enum RequestStatus {
  DRAFT
  OPEN
  CLOSED
  HIRED
}

enum ProposalStatus {
  DRAFT
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum CaseStatus {
  ACTIVE
  COMPLETED
  DISPUTED
  CANCELLED
}

enum MilestoneStatus {
  PENDING
  DONE
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum ProviderBusinessType {
  AGENT
  SCHOOL
  LAW
}

enum PlanCode {
  FREE
  PRO
  AGENCY
}

enum SubscriptionStatus {
  INCOMPLETE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum VerificationCaseStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
  REJECTED
}

enum DisputeCaseStatus {
  OPEN
  RESOLVED
  ESCALATED
}

enum CreditTransactionType {
  PURCHASE
  SPEND
  REFUND
  GRANT
}

enum AdminRole {
  ADMIN
  MODERATOR
  FINANCE
  SUPPORT
}

enum BannerType {
  INFO
  WARN
  CRITICAL
}

enum ReportStatus {
  OPEN
  ACTIONED
  DISMISSED
}

// ==================== CORE MODELS ====================

model User {
  id                      String    @id @default(uuid())
  email                   String    @unique @db.VarChar(255)
  role                    UserRole
  name                    String?   @db.VarChar(200)
  phone                   String?   @db.VarChar(50)
  locale                  String    @default("en") @db.VarChar(10)
  passwordHash            String?   // Hashed password (bcrypt)
  passwordResetTokenHash  String?   // Hashed reset token (bcrypt)
  passwordResetTokenHashSha256 String? // SHA-256 hash
  passwordResetTokenExpiry DateTime?
  emailVerified          Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationTokenExpiry DateTime?
  onboardingCompleted    Boolean   @default(false)
  onboardingCompletedAt   DateTime?
  seekerOnboardingCompleted Boolean @default(false)
  providerOnboardingCompleted Boolean @default(false)
  providerBusinessStepCompleted Boolean @default(false)
  providerServicesStepCompleted Boolean @default(false)
  providerCredentialsStepCompleted Boolean @default(false)
  createdAt               DateTime  @default(now())

  // Relations
  providerProfile  ProviderProfile?
  requests         Request[]        @relation("SeekerRequests")
  sentMessages     Message[]        @relation("MessageSender")
  ownedAttachments Attachment[]     @relation("AttachmentOwner")
  notifications    Notification[]
  createdReports   Report[]         @relation("ReportReporter")
  authoredNotes    InternalNote[]
  auditLogs        AuditLog[]       @relation("AuditLogActor")

  @@index([email])
  @@index([role])
}

model ProviderProfile {
  id           String    @id @default(uuid())
  userId       String    @unique
  businessName String    @db.VarChar(200)
  businessType ProviderBusinessType?
  description  String?   @db.Text
  location     String?   @db.VarChar(200)
  languages    Json      @default("[]")
  website      String?   @db.VarChar(500)
  contactPhone String?   @db.VarChar(50)
  yearsExperience Int?
  verifiedAt   DateTime?
  credits      Int       @default(0) // Credit ledger
  createdAt    DateTime  @default(now())

  // Relations
  user             User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  servicePackages  ServicePackage[]
  proposals        Proposal[]
  billingCustomer  BillingCustomer?
  subscriptions    Subscription[]
  creditTransactions CreditTransaction[]
  verificationCase VerificationCase[]
  cases            Case[]

  @@index([userId])
  @@index([businessName])
  @@index([credits])
}

model ServicePackage {
  id           String   @id @default(uuid())
  providerId   String
  title        String   @db.VarChar(200)
  description  String   @db.VarChar(2000)
  priceTHB     Decimal  @db.Decimal(10, 2)
  deliverables Json     @default("[]")
  etaDays      Int
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model Request {
  id          String        @id @default(uuid())
  seekerId    String
  title       String        @db.VarChar(200)
  description String        @db.Text
  visaType    String?       @db.VarChar(100)
  budget      String?       @db.VarChar(100) // e.g. "THB 50k-80k"
  location    String?       @db.VarChar(200)
  status      RequestStatus @default(DRAFT)
  intakeData  Json?         // Raw intake form data
  createdAt   DateTime      @default(now())

  // Relations
  seeker      User         @relation("SeekerRequests", fields: [seekerId], references: [id], onDelete: Restrict)
  messages    Message[]
  proposals   Proposal[]
  attachments Attachment[]

  @@index([seekerId])
  @@index([status])
}

model Message {
  id        String   @id @default(uuid())
  requestId String
  senderId  String
  body      String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  sender  User    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Restrict)

  @@index([requestId])
  @@index([senderId])
}

model Proposal {
  id         String      @id @default(uuid())
  requestId  String
  providerId String
  totalTHB   Decimal     @db.Decimal(10, 2)
  timeline   String?     @db.VarChar(200)
  terms      String?     @db.Text
  status     ProposalStatus @default(DRAFT)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relations
  request  Request         @relation(fields: [requestId], references: [id], onDelete: Cascade)
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Restrict)
  case     Case?

  @@index([requestId])
  @@index([providerId])
}

model Case {
  id            String       @id @default(uuid())
  proposalId    String       @unique
  status        CaseStatus   @default(ACTIVE)
  paymentStatus PaymentStatus @default(UNPAID)
  providerId    String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  proposal    Proposal        @relation(fields: [proposalId], references: [id], onDelete: Restrict)
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Restrict)
  milestones  Milestone[]
  reviews     Review[]
  disputeCase DisputeCase?

  @@index([proposalId])
  @@index([status])
}

model Milestone {
  id        String          @id @default(uuid())
  caseId    String
  title     String          @db.VarChar(200)
  dueAt     DateTime
  status    MilestoneStatus @default(PENDING)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}

model Review {
  id        String   @id @default(uuid())
  caseId    String
  rating    Int // 1-5
  text      String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}

model Attachment {
  id          String   @id @default(uuid())
  ownerUserId String
  requestId   String?
  caseId      String?
  key         String   @db.VarChar(500)
  mime        String   @db.VarChar(100)
  size        Int
  createdAt   DateTime @default(now())

  // Relations
  owner   User     @relation("AttachmentOwner", fields: [ownerUserId], references: [id], onDelete: Restrict)
  request Request? @relation(fields: [requestId], references: [id], onDelete: SetNull)

  @@index([ownerUserId])
  @@index([requestId])
  @@index([caseId])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String    @db.VarChar(100)
  payload   Json
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== BILLING & CREDITS ====================

model BillingCustomer {
  id               String   @id @default(uuid())
  providerId       String   @unique
  stripeCustomerId String   @unique @db.VarChar(255)
  createdAt        DateTime @default(now())

  // Relations
  provider      ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Restrict)
  invoices      Invoice[]

  @@index([providerId])
}

model Subscription {
  id                   String             @id @default(uuid())
  providerId           String
  stripeSubscriptionId String             @unique @db.VarChar(255)
  planCode             PlanCode
  status               SubscriptionStatus @default(INCOMPLETE)
  currentPeriodEnd     DateTime
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([status])
}

model CreditTransaction {
  id         String                @id @default(uuid())
  providerId String
  amount     Int // Positive (purchase) or negative (spend)
  type       CreditTransactionType
  reason     String?               @db.VarChar(255)
  createdAt  DateTime              @default(now())

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model Invoice {
  id                String    @id @default(uuid())
  billingCustomerId String
  stripeInvoiceId   String    @unique @db.VarChar(255)
  amount            Decimal   @db.Decimal(10, 2)
  status            String    @db.VarChar(50)
  url               String?   @db.VarChar(500)
  createdAt         DateTime  @default(now())

  // Relations
  billingCustomer BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  @@index([billingCustomerId])
}

// ==================== ADMIN & OPS ====================

model AdminUser {
  id         String    @id @default(uuid())
  email      String    @unique @db.VarChar(255)
  role       AdminRole
  createdAt  DateTime  @default(now())

  // Relations
  reviewedVerificationCases VerificationCase[] @relation("VerificationCaseReviewer")
  handledDisputeCases       DisputeCase[]      @relation("DisputeCaseHandler")

  @@index([email])
}

model VerificationCase {
  id         String                 @id @default(uuid())
  providerId String
  status     VerificationCaseStatus @default(PENDING)
  checklist  Json
  reviewerId String?
  decidedAt  DateTime?
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Restrict)
  reviewer AdminUser?      @relation("VerificationCaseReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)

  @@index([providerId])
  @@index([status])
}

model DisputeCase {
  id         String            @id @default(uuid())
  caseId     String            @unique
  status     DisputeCaseStatus @default(OPEN)
  resolution Json?
  handlerId  String?
  openedAt   DateTime          @default(now())
  closedAt   DateTime?

  // Relations
  case    Case       @relation(fields: [caseId], references: [id], onDelete: Restrict)
  handler AdminUser? @relation("DisputeCaseHandler", fields: [handlerId], references: [id], onDelete: SetNull)

  @@index([caseId])
  @@index([status])
}

model FeatureFlag {
  key       String   @id @db.VarChar(100)
  enabled   Boolean  @default(false)
  audience  Json     @default("{}")
  updatedAt DateTime @updatedAt
}

model Banner {
  id         String     @id @default(uuid())
  title      String     @db.VarChar(200)
  message    String     @db.Text
  type       BannerType
  activeFrom DateTime
  activeTo   DateTime?
  createdAt  DateTime   @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  actorRole   String   @db.VarChar(50)
  action      String   @db.VarChar(100)
  entityType  String   @db.VarChar(100)
  entityId    String   @db.VarChar(255)
  diff        Json?
  ip          String?  @db.VarChar(45)
  createdAt   DateTime @default(now())

  // Relations
  actor User? @relation("AuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId])
  @@index([createdAt])
}

model InternalNote {
  id         String   @id @default(uuid())
  entityType String   @db.VarChar(100)
  entityId   String   @db.VarChar(255)
  authorId   String
  body       String   @db.Text
  createdAt  DateTime @default(now())

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId])
}

model Report {
  id             String       @id @default(uuid())
  entityType     String       @db.VarChar(100)
  entityId       String       @db.VarChar(255)
  reporterUserId String
  reason         String       @db.Text
  status         ReportStatus @default(OPEN)
  createdAt      DateTime     @default(now())

  // Relations
  reporter User @relation("ReportReporter", fields: [reporterUserId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId])
}
